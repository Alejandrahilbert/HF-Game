
-148

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cockpit Cleanup Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
  <style>
    :root {
      --ink: #0b0f20;
      --panel: #10162e;
      --panel-2: #141c36;
      --accent: #6ef3c5;
      --accent-2: #ffcf58;
      --alert: #ff6b6b;
      --focus: #4cb3ff;
      --text: #f5f8ff;
      --muted: #9db1d1;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      --radius: 14px;
      --pixel: "Press Start 2P", "VT323", "Courier New", monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, #1a2140, #0b0f20 60%),
        radial-gradient(circle at 80% 0%, #1d2348, #0b0f20 55%);
      color: var(--text);
      font-family: var(--pixel);
      letter-spacing: 0.35px;
    }

    h1, h2, h3 { margin: 0; }

    .frame {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 18px 32px;
    }

    .top-bar {
      background: linear-gradient(135deg, #1b2346, #141a30);
      border: 2px solid #1f2c52;
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px 18px 14px;
      display: grid;
      gap: 10px;
    }

    .top-bar .title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 22px;
    }

    .title .badge {
      background: var(--accent);
      color: #062016;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      box-shadow: 0 3px 0 #2d8d6e;
    }

    .subtitle {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
      margin-top: 16px;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .cockpit { min-height: 520px; }
    }

    .cockpit {
      background: linear-gradient(180deg, #10162e, #0b0f22);
      border: 2px solid #1f2a4f;
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .cockpit::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      opacity: 0.6;
    }

    .cockpit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 2;
      margin-bottom: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .cockpit-header h2 { font-size: 16px; }

    .cockpit-hint {
      color: var(--muted);
      font-size: 11px;
      line-height: 1.4;
    }

    .rules {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--text);
    }

    .rule-chip {
      background: rgba(76, 179, 255, 0.14);
      border: 1px solid rgba(76, 179, 255, 0.25);
      padding: 8px 10px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .rule-chip strong { color: var(--accent-2); }

    .instrument-area {
      position: relative;
      border: 2px dashed rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      min-height: 520px;
      padding: 10px;
      overflow: hidden;
      background: linear-gradient(160deg, rgba(108, 168, 255, 0.08), rgba(78, 242, 197, 0.06));
    }

    .instrument {
      position: absolute;
      width: 170px;
      min-height: 120px;
      background: var(--panel);
      border: 2px solid #2b345d;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.32);
      cursor: grab;
      transition: transform 0.08s ease, border 0.1s ease, box-shadow 0.08s ease, background 0.08s ease;
      user-select: none;
      color: var(--text);
    }

    .instrument:active { cursor: grabbing; }

    .instrument h3 {
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .instrument h3 span {
      background: rgba(255, 255, 255, 0.08);
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 10px;
      color: var(--muted);
    }

    .instrument .kid-label {
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .instrument .readout {
      font-size: 22px;
      margin: 8px 0 4px;
      color: var(--accent-2);
      text-shadow: 0 0 6px rgba(255, 207, 88, 0.4);
    }

    .instrument .notes {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.5;
    }

    .instrument.safe { border-color: #2e9b6f; box-shadow: 0 0 10px rgba(46, 155, 111, 0.35); }
    .instrument.watch { border-color: #ffcf58; box-shadow: 0 0 12px rgba(255, 207, 88, 0.45); background: #1b1f36; }
    .instrument.alert { border-color: var(--alert); box-shadow: 0 0 14px rgba(255, 107, 107, 0.6); animation: pulse 0.6s infinite; background: #1e1323; }
    .instrument.focused { outline: 2px dashed var(--focus); }

    @keyframes pulse {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    .focus-zone {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 82%;
      min-height: 120px;
      border: 2px dashed var(--focus);
      border-radius: 10px;
      color: var(--focus);
      display: grid;
      place-items: center;
      text-align: center;
      padding: 12px;
      background: rgba(76, 179, 255, 0.07);
      z-index: 1;
      pointer-events: none;
      font-size: 11px;
    }

    .control-panel {
      background: linear-gradient(180deg, #141a31, #0e1428);
      border: 2px solid #1f2c52;
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 14px;
      align-content: start;
    }

    .panel {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .panel h3 { font-size: 13px; }

    .meters { display: grid; gap: 10px; }

    .meter {
      display: grid;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .meter-bar {
      position: relative;
      width: 100%;
      height: 14px;
      background: #101733;
      border: 1px solid #2c3863;
      border-radius: 6px;
      overflow: hidden;
    }

    .meter-bar .fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #38ef7d, #11998e);
      width: 50%;
      transition: width 0.25s ease;
    }

    .meter-bar .fill.caution { background: linear-gradient(90deg, #ffcf58, #ff8a00); }
    .meter-bar .fill.alert { background: linear-gradient(90deg, #ff6b6b, #c44536); }

    .controls { display: flex; flex-wrap: wrap; gap: 8px; }

    button {
      font-family: var(--pixel);
      font-size: 11px;
      background: var(--accent);
      color: #062016;
      border: 2px solid #1d8b66;
      border-radius: 8px;
      padding: 10px 12px;
      cursor: pointer;
      box-shadow: 0 5px 0 #166a4f;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    button.secondary {
      background: #4cb3ff;
      color: #041425;
      border-color: #2b7bb3;
      box-shadow: 0 5px 0 #1f5d8a;
    }

    button:active {
      transform: translateY(2px);
      box-shadow: 0 3px 0 rgba(0, 0, 0, 0.35);
    }

    .event-log {
      max-height: 220px;
      overflow-y: auto;
      background: #0b0f23;
      border: 1px solid #1d2647;
      border-radius: 8px;
      padding: 10px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.6;
    }

    .log-entry { margin-bottom: 6px; }
    .log-entry strong { color: var(--accent-2); }

    .notes-list { margin: 0; padding-left: 16px; color: var(--muted); font-size: 11px; line-height: 1.6; }

    .hint {
      font-size: 11px;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.04);
      padding: 8px;
      border-radius: 8px;
      border: 1px dashed rgba(255, 255, 255, 0.12);
      line-height: 1.5;
    }

    .task-list {
      margin: 0;
      padding-left: 16px;
      color: var(--text);
      font-size: 11px;
      display: grid;
      gap: 6px;
    }

    .task-list li {
      background: rgba(76, 179, 255, 0.08);
      border: 1px solid rgba(76, 179, 255, 0.15);
      border-radius: 8px;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .task-list .tag {
      font-size: 9px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      padding: 2px 6px;
      color: var(--muted);
    }

    .task-time {
      font-size: 9px;
      color: var(--accent-2);
      background: rgba(255, 207, 88, 0.12);
      border: 1px solid rgba(255, 207, 88, 0.25);
      border-radius: 6px;
      padding: 2px 6px;
    }

    .deck-map {
      display: grid;
      gap: 6px;
      font-size: 11px;
      color: var(--text);
    }

    .deck-chip {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 6px 8px;
      gap: 8px;
    }

    .deck-chip .meta {
      display: flex;
      gap: 6px;
      color: var(--muted);
      font-size: 10px;
    }

    .importance-critical { color: #ff9aa2; }
    .importance-supporting { color: #9ae6b4; }
    .importance-niceToHave { color: #a5b4fc; }

    .story {
      display: grid;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .progress-bar {
      position: relative;
      width: 100%;
      height: 12px;
      background: #0f1834;
      border: 1px solid #23305c;
      border-radius: 8px;
      overflow: hidden;
    }

    .progress-bar .fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #a5f3fc, #4cb3ff);
      width: 10%;
      transition: width 0.4s ease;
    }

    .sa-quiz {
      position: absolute;
      inset: 0;
      background: rgba(6, 10, 22, 0.9);
      color: var(--text);
      display: none;
      place-items: center;
      z-index: 4;
    }

    .quiz-card {
      background: #101733;
      border: 2px solid #2b7bb3;
      border-radius: 14px;
      padding: 18px;
      width: min(480px, 92vw);
      display: grid;
      gap: 12px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .quiz-card h3 { font-size: 15px; }

    .quiz-options { display: grid; gap: 8px; }

    .quiz-options button { width: 100%; }

    .tutorial-overlay {
      position: absolute;
      inset: 0;
      background: rgba(9, 12, 24, 0.88);
      color: var(--text);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
      text-align: center;
      padding: 18px;
    }

    .tutorial-card {
      background: #131a35;
      border: 2px solid #2b7bb3;
      border-radius: 14px;
      padding: 18px;
      width: min(520px, 94vw);
      display: grid;
      gap: 12px;
      box-shadow: var(--shadow);
    }

    .tutorial-card h3 { font-size: 16px; }
    .tutorial-card p { font-size: 12px; line-height: 1.6; color: var(--muted); }
  </style>
</head>
<body>
  <div class="frame">
    <header class="top-bar">
      <div class="title">
        <div class="badge">8-BIT LAB</div>
        <h1>Cockpit Cleanup Challenge</h1>
      </div>
      <div class="subtitle">
        Drag and drop instruments, respond to alerts, and test whether a tidier cockpit helps you fly smoother.
        Built for middle school pilots to explore clutter, attention, and smart layout choices.
      </div>
    </header>

    <div class="layout">
      <section class="cockpit">
        <div class="cockpit-header">
          <div>
            <h2>Flight Deck Sandbox</h2>
            <div class="cockpit-hint">Move critical gauges into the Focus Zone. Tap flashing red panels fast.</div>
          </div>
          <div class="rules">
            <div class="rule-chip"><strong>1.</strong> Keep Speed, Height, Direction together.</div>
            <div class="rule-chip"><strong>2.</strong> Click anything that flashes red.</div>
          </div>
        </div>
        <div class="instrument-area" id="instrument-area"></div>
        <div class="focus-zone" id="focus-zone">Focus Zone ‚Äî tighter grouping = faster reactions</div>
        <div class="tutorial-overlay" id="tutorial">
          <div class="tutorial-card" id="tutorial-card">
            <h3>Flight School</h3>
            <p id="tutorial-text">Welcome pilot! Let's make this cockpit kid-friendly.</p>
            <button id="tutorial-next">Next</button>
          </div>
        </div>
        <div class="sa-quiz" id="quiz">
          <div class="quiz-card">
            <h3 id="quiz-title">Quick Check</h3>
            <p id="quiz-question">What is your speed?</p>
            <div class="quiz-options" id="quiz-options"></div>
          </div>
        </div>
      </section>

      <aside class="control-panel">
        <div class="panel">
          <h3>Mission Status</h3>
          <div class="meters">
            <div class="meter">
              <div>Situational Awareness</div>
              <div class="meter-bar"><div class="fill" id="awareness-bar"></div></div>
            </div>
            <div class="meter">
              <div>Clutter Level</div>
              <div class="meter-bar"><div class="fill caution" id="clutter-bar"></div></div>
            </div>
            <div class="meter">
              <div>Fatigue</div>
              <div class="meter-bar"><div class="fill alert" id="fatigue-bar"></div></div>
            </div>
          </div>
          <div class="story">
            <div><strong>Mission:</strong> Deliver medical supplies safely.</div>
            <div class="progress-bar"><div class="fill" id="mission-progress"></div></div>
            <div>Catch alerts to keep passengers calm.</div>
          </div>
        </div>

        <div class="panel">
          <h3>Controls</h3>
          <div class="controls">
            <button id="start-btn">Start</button>
            <button id="stop-btn" class="secondary">Pause</button>
            <button id="shuffle-btn" class="secondary">Shuffle Clutter</button>
            <button id="reset-btn">Reset Layout</button>
            <button id="tutorial-btn">Flight School</button>
          </div>
          <div class="hint">Try Level 1 with only Speed and Height. Then level up to add Direction, Warnings, and Weather.</div>
        </div>

        <div class="panel">
          <h3>Training Level</h3>
          <div class="controls">
            <button id="level-1">Level 1</button>
            <button id="level-2" class="secondary">Level 2</button>
            <button id="level-3" class="secondary">Level 3</button>
            <button id="level-4" class="secondary">Level 4</button>
            <button id="level-5" class="secondary">Level 5</button>
          </div>
          <div class="hint">Higher levels add checklists, engine health, flaps/trim, and extra alerts. Keep it tidy.</div>
        </div>

        <div class="panel">
          <h3>Deck Map</h3>
          <div class="deck-map" id="deck-map"></div>
          <div class="hint">Critical = pink, Supporting = green, Nice-to-have = violet. Group pink gauges in the Focus Zone.</div>
        </div>

        <div class="panel">
          <h3>Active Tasks</h3>
          <ul class="task-list" id="task-list">
            <li><span>Tasks will appear once you start.</span><span class="tag">Pending</span></li>
          </ul>
        </div>

        <div class="panel">
          <h3>End-of-Round Notes</h3>
          <ul class="notes-list" id="summary-list">
            <li>Keep critical gauges tight.</li>
            <li>Tap red alerts fast.</li>
            <li>Watch false alarms.</li>
          </ul>
        </div>

        <div class="panel">
          <h3>Event Log</h3>
          <div class="event-log" id="event-log"></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const instrumentArea = document.getElementById('instrument-area');
    const focusZone = document.getElementById('focus-zone');
    const logEl = document.getElementById('event-log');
    const awarenessBar = document.getElementById('awareness-bar');
    const clutterBar = document.getElementById('clutter-bar');
    const fatigueBar = document.getElementById('fatigue-bar');
    const missionProgress = document.getElementById('mission-progress');
    const summaryList = document.getElementById('summary-list');
    const deckMapEl = document.getElementById('deck-map');

    const quizOverlay = document.getElementById('quiz');
    const quizQuestion = document.getElementById('quiz-question');
    const quizOptions = document.getElementById('quiz-options');
    const quizTitle = document.getElementById('quiz-title');

    const tutorialOverlay = document.getElementById('tutorial');
    const tutorialText = document.getElementById('tutorial-text');
    const tutorialNext = document.getElementById('tutorial-next');

    const TutorialStep = {
      Intro: 0,
      ExplainSpeed: 1,
      ExplainHeight: 2,
      ExplainFocus: 3,
      FirstAlert: 4,
      Done: 5,
    };

    const LevelDesign = [
      { name: 'Tutorial', ids: ['airspeed', 'altimeter'] },
      { name: 'Level 1 ‚Äî Speed & Height', ids: ['airspeed', 'altimeter'] },
      { name: 'Level 2 ‚Äî Add Direction', ids: ['airspeed', 'altimeter', 'heading', 'trim'] },
      { name: 'Level 3 ‚Äî Warnings & Engines', ids: ['airspeed', 'altimeter', 'heading', 'warning', 'engine', 'flaps'] },
      { name: 'Level 4 ‚Äî Weather & Radios', ids: ['airspeed', 'altimeter', 'heading', 'warning', 'weather', 'radio', 'fuel'] },
      { name: 'Level 5 ‚Äî Full Deck', ids: ['airspeed', 'altimeter', 'heading', 'warning', 'weather', 'radio', 'fuel', 'cabin', 'checklist', 'engine', 'flaps', 'trim'] },
    ];

    const instruments = [
      {
        id: 'airspeed',
        techName: 'Airspeed',
        kidName: 'Speed',
        icon: 'üöÄ',
        importance: 'critical',
        group: 'flight',
        readout: '245 kts',
        note: 'Speed in the green keeps us happy.',
      },
      {
        id: 'altimeter',
        techName: 'Altimeter',
        kidName: 'Height',
        icon: 'üß≠',
        importance: 'critical',
        group: 'flight',
        readout: '12,300 ft',
        note: 'How high we are above Earth.',
      },
      {
        id: 'heading',
        techName: 'Heading',
        kidName: 'Direction',
        icon: 'üß≠',
        importance: 'critical',
        group: 'navigation',
        readout: '095¬∞',
        note: 'Compass direction. Keep it steady.',
      },
      {
        id: 'trim',
        techName: 'Trim',
        kidName: 'Trim',
        icon: '‚öôÔ∏è',
        importance: 'supporting',
        group: 'flight',
        readout: 'Neutral',
        note: 'Fine tune to keep the plane level.',
      },
      {
        id: 'weather',
        techName: 'Weather Radar',
        kidName: 'Weather',
        icon: '‚õÖÔ∏è',
        importance: 'supporting',
        group: 'weather',
        readout: 'Storms NE',
        note: 'Watch for storms and lightning.',
      },
      {
        id: 'radio',
        techName: 'Nav Radios',
        kidName: 'Radio',
        icon: 'üì°',
        importance: 'supporting',
        group: 'navigation',
        readout: 'VOR 114.3',
        note: 'Tune towers to stay on route.',
      },
      {
        id: 'engine',
        techName: 'Engine',
        kidName: 'Engines',
        icon: 'üõ†Ô∏è',
        importance: 'supporting',
        group: 'warning',
        readout: '92% thrust',
        note: 'Check temps & fuel flow.',
      },
      {
        id: 'flaps',
        techName: 'Flaps',
        kidName: 'Flaps',
        icon: 'ü™Ω',
        importance: 'supporting',
        group: 'flight',
        readout: '15¬∞',
        note: 'Use for takeoff/landing. Reset when safe.',
      },
      {
        id: 'warning',
        techName: 'Caution Lights',
        kidName: 'Warnings',
        icon: '‚ö†Ô∏è',
        importance: 'critical',
        group: 'warning',
        readout: 'No alerts',
        note: 'Flashes red when something is wrong.',
      },
      {
        id: 'fuel',
        techName: 'Fuel Monitor',
        kidName: 'Fuel',
        icon: '‚õΩÔ∏è',
        importance: 'supporting',
        group: 'warning',
        readout: '68% left',
        note: 'Keep above 40% for safety.',
      },
      {
        id: 'cabin',
        techName: 'Cabin Pressure',
        kidName: 'Cabin',
        icon: 'ü´ß',
        importance: 'supporting',
        group: 'warning',
        readout: 'Stable',
        note: 'Watch passengers comfort level.',
      },
      {
        id: 'checklist',
        techName: 'Checklist',
        kidName: 'Checklist',
        icon: 'üìã',
        importance: 'niceToHave',
        group: 'checklist',
        readout: 'Approach',
        note: 'Tap to verify steps.',
      },
    ];

    const state = {
      running: false,
      activeAlert: null,
      tutorialStep: TutorialStep.Intro,
      levelIndex: 1,
      questionTimer: null,
      taskTimer: null,
      taskTickTimer: null,
      alertTimer: null,
      fatigueTimer: null,
      sa_score: 65,
      clutter_level: 65,
      fatigue: 20,
      mission_progress: 0,
      hits: 0,
      misses: 0,
      false_alarms: 0,
      correct_rejections: 0,
      layout: {},
      elements: {},
      tasks: [],
    };

    function log(message, highlight) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = highlight ? `<strong>${message}</strong>` : message;
      logEl.prepend(entry);
      while (logEl.children.length > 30) logEl.removeChild(logEl.lastChild);
    }

    function randomPosition() {
      const areaRect = instrumentArea.getBoundingClientRect();
      const width = 170;
      const height = 120;
      const padding = 10;
      const x = Math.random() * (areaRect.width - width - padding * 2) + padding;
      const y = Math.random() * (areaRect.height - height - padding * 2) + padding;
      return { x, y };
    }

    function createInstrument(inst) {
      const el = document.createElement('div');
      el.className = 'instrument safe';
      el.draggable = true;
      el.dataset.id = inst.id;
      el.innerHTML = `
        <h3><span>${inst.kidName}</span><span>${inst.techName}</span></h3>
        <div class="kid-label">${inst.icon} ${inst.kidName}</div>
        <div class="readout">${inst.readout}</div>
        <div class="notes">${inst.note}</div>
      `;

      el.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', inst.id);
        const rect = el.getBoundingClientRect();
        el.dataset.offsetX = e.clientX - rect.left;
        el.dataset.offsetY = e.clientY - rect.top;
      });

      el.addEventListener('dragend', (e) => {
        const offsetX = Number(el.dataset.offsetX || 0);
        const offsetY = Number(el.dataset.offsetY || 0);
        const areaRect = instrumentArea.getBoundingClientRect();
        const newX = Math.min(Math.max(e.clientX - areaRect.left - offsetX, 4), areaRect.width - el.offsetWidth - 4);
        const newY = Math.min(Math.max(e.clientY - areaRect.top - offsetY, 4), areaRect.height - el.offsetHeight - 4);
        setPosition(el, { x: newX, y: newY });
        updateFocusFlag(el);
        updateClutterAndGrouping();
      });

      el.addEventListener('click', () => {
        if (state.activeAlert && state.activeAlert.id === inst.id) {
          resolveAlert(inst.id, 'Acknowledged');
        }
        const pending = state.tasks.find((t) => t.instId === inst.id && t.type === 'check');
        if (pending) {
          completeTask(pending.id, 6);
          log(`Checked ${inst.kidName}.`, true);
        }
      });

      instrumentArea.appendChild(el);
      const pos = randomPosition();
      setPosition(el, pos);
      state.layout[inst.id] = pos;
      state.elements[inst.id] = el;
      updateFocusFlag(el);
    }

    function setPosition(el, pos) {
      el.style.left = `${pos.x}px`;
      el.style.top = `${pos.y}px`;
      state.layout[el.dataset.id] = pos;
    }

    function resetLayout() {
      Array.from(document.querySelectorAll('.instrument')).forEach((el) => {
        const pos = randomPosition();
        setPosition(el, pos);
        el.classList.remove('focused');
      });
      updateClutterAndGrouping();
      log('Layout reset ‚Äî start testing new ideas!');
    }

    function shuffleClutter() {
      Array.from(document.querySelectorAll('.instrument')).forEach((el) => {
        const pos = randomPosition();
        setPosition(el, pos);
      });
      updateClutterAndGrouping();
      log('We scattered the gauges. Try organizing them.');
    }

    function isInsideFocus(el) {
      const focusRect = focusZone.getBoundingClientRect();
      const instRect = el.getBoundingClientRect();
      return (
        instRect.left >= focusRect.left &&
        instRect.right <= focusRect.right &&
        instRect.top >= focusRect.top &&
        instRect.bottom <= focusRect.bottom
      );
    }

    function updateFocusFlag(el) {
      const inside = isInsideFocus(el);
      el.classList.toggle('focused', inside);
      el.dataset.inFocus = inside;
      checkTasks();
    }

    function averagePairwiseDistance(nodes) {
      if (nodes.length < 2) return 0;
      let total = 0;
      let count = 0;
      for (let i = 0; i < nodes.length; i++) {
        for (let j = i + 1; j < nodes.length; j++) {
          const a = state.layout[nodes[i].dataset.id];
          const b = state.layout[nodes[j].dataset.id];
          if (a && b) {
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            total += Math.sqrt(dx * dx + dy * dy);
            count++;
          }
        }
      }
      return count ? total / count : 0;
    }

    function normalize(value) {
      return Math.max(0, Math.min(100, value));
    }

    function updateClutterAndGrouping() {
      const all = Array.from(document.querySelectorAll('.instrument'));
      const critical = all.filter((el) => {
        const inst = instruments.find((i) => i.id === el.dataset.id);
        return inst && inst.importance === 'critical';
      });
      const avgDistance = averagePairwiseDistance(critical);
      const countScore = all.length * 0.4;
      const distanceScore = avgDistance * 0.02;
      state.clutter_level = normalize(countScore * 0.4 + distanceScore * 60);

      const inZone = critical.filter((el) => isInsideFocus(el));
      const ratio = critical.length ? inZone.length / critical.length : 0;
      if (ratio > 0.75) state.sa_score = Math.min(100, state.sa_score + 0.5);

      const fatigueBoost = state.clutter_level * 0.004;
      state.fatigue = normalize(state.fatigue + fatigueBoost);
      renderMeters();
    }

    function renderMeters() {
      awarenessBar.style.width = `${state.sa_score}%`;
      clutterBar.style.width = `${state.clutter_level}%`;
      fatigueBar.style.width = `${state.fatigue}%`;
      missionProgress.style.width = `${state.mission_progress * 100}%`;
    }

    function renderTasks() {
      const list = document.getElementById('task-list');
      list.innerHTML = '';
      if (!state.tasks.length) {
        const li = document.createElement('li');
        li.innerHTML = '<span>No active tasks.</span><span class="tag">Clear</span>';
        list.appendChild(li);
        return;
      }
      state.tasks.forEach((task) => {
        const li = document.createElement('li');
        const remaining = Math.max(0, Math.ceil((task.expiresAt - Date.now()) / 1000));
        const timeTag = `<span class="task-time">${remaining}s</span>`;
        li.innerHTML = `<span>${task.description}</span><span class="tag">${task.type}</span>${timeTag}`;
        list.appendChild(li);
      });
    }

    function renderDeckMap() {
      if (!deckMapEl) return;
      deckMapEl.innerHTML = '';
      const level = LevelDesign[state.levelIndex] || LevelDesign[1];
      level.ids.forEach((id) => {
        const inst = instruments.find((i) => i.id === id);
        if (!inst) return;
        const row = document.createElement('div');
        row.className = 'deck-chip';
        row.innerHTML = `
          <span>${inst.icon} ${inst.kidName}</span>
          <span class="meta">
            <span class="importance-${inst.importance}">${inst.importance}</span>
            <span>${inst.group}</span>
          </span>
        `;
        deckMapEl.appendChild(row);
      });
      if (!deckMapEl.children.length) deckMapEl.textContent = 'No gauges in this level yet.';
    }

    function addTask(task) {
      state.tasks.push(task);
      log(`New task: ${task.description}`);
      renderTasks();
    }

    function completeTask(taskId, boost = 4) {
      state.tasks = state.tasks.filter((t) => t.id !== taskId);
      state.sa_score = Math.min(100, state.sa_score + boost);
      state.fatigue = Math.max(0, state.fatigue - boost / 2);
      state.mission_progress = Math.min(1, state.mission_progress + 0.03);
      renderTasks();
      renderMeters();
    }

    function failTask(task) {
      state.tasks = state.tasks.filter((t) => t.id !== task.id);
      state.sa_score = Math.max(0, state.sa_score - 4);
      state.clutter_level = Math.min(100, state.clutter_level + 6);
      state.fatigue = Math.min(100, state.fatigue + 4);
      state.mission_progress = Math.max(0, state.mission_progress - 0.02);
      log(`Missed task: ${task.description}`);
      renderTasks();
      renderMeters();
      updateSummary();
    }

    function tickTasks() {
      const now = Date.now();
      const expired = state.tasks.filter((t) => t.expiresAt <= now);
      expired.forEach((task) => failTask(task));
      if (expired.length) renderTasks();
      else renderTasks();
    }

    function checkTasks() {
      state.tasks.forEach((task) => {
        const el = state.elements[task.instId];
        if (!el) return;
        if (task.type === 'focus' && el.dataset.inFocus === 'true') {
          completeTask(task.id);
          log(`Task complete: ${task.description}`, true);
        }
      });
    }

    function triggerAlert() {
      if (!state.running) return;
      const available = activeInstrumentIds().filter((id) => !state.activeAlert || state.activeAlert.id !== id);
      if (!available.length) return;
      const instId = available[Math.floor(Math.random() * available.length)];
      const instData = instruments.find((i) => i.id === instId);
      const el = state.elements[instId];
      state.activeAlert = { id: instId, started: performance.now(), realProblem: Math.random() > 0.25 };
      el.classList.remove('safe', 'watch');
      el.classList.add('alert');
      el.querySelector('.notes').textContent = state.activeAlert.realProblem ? 'Danger ‚Äî fix it!' : 'Hmm... maybe fake?';
      log(`${instData.kidName} flashing ‚Äî click to clear.`);

      setTimeout(() => {
        if (state.activeAlert && state.activeAlert.id === instId) {
          resolveAlert(instId, 'Missed');
        }
      }, 4500 + state.clutter_level * 8);
    }

    function resolveAlert(id, result) {
      const el = state.elements[id];
      if (!el) return;
      const inst = instruments.find((i) => i.id === id);
      el.classList.remove('alert');
      el.classList.add('watch');
      el.querySelector('.notes').textContent = inst.note;

      if (result === 'Acknowledged') {
        const responseTime = Math.max(0, performance.now() - state.activeAlert.started);
        const focusBonus = isInsideFocus(el) ? 8 : 0;
        const speedScore = Math.max(4, 25 - responseTime / 400);
        state.sa_score = Math.min(100, state.sa_score + speedScore + focusBonus);
        state.clutter_level = Math.max(5, state.clutter_level - (speedScore / 2 + focusBonus));
        state.fatigue = Math.max(0, state.fatigue - (focusBonus / 2));
        state.mission_progress = Math.min(1, state.mission_progress + 0.05);
        recordTrial(state.activeAlert.realProblem ? 'hit' : 'false_alarm');
        log(`Cleared ${inst.kidName} in ${(responseTime / 1000).toFixed(1)}s ‚Äî nice!`, true);
      } else {
        state.sa_score = Math.max(10, state.sa_score - 8);
        state.clutter_level = Math.min(100, state.clutter_level + 10);
        state.fatigue = Math.min(100, state.fatigue + 8);
        recordTrial(state.activeAlert.realProblem ? 'miss' : 'correct_rejection');
        log(`${inst.kidName} ignored ‚Äî cockpit felt messy.`, true);
      }

      state.activeAlert = null;
      renderMeters();
      updateSummary();
    }

    function recordTrial(outcome) {
      if (outcome === 'hit') state.hits++;
      if (outcome === 'miss') state.misses++;
      if (outcome === 'false_alarm') state.false_alarms++;
      if (outcome === 'correct_rejection') state.correct_rejections++;

      if (outcome === 'miss') {
        state.sa_score = Math.max(0, state.sa_score - 3);
        state.fatigue = Math.min(100, state.fatigue + 2);
      }
      if (outcome === 'false_alarm') state.fatigue = Math.min(100, state.fatigue + 1);
      renderMeters();
    }

    function tickFatigue() {
      state.fatigue = Math.min(100, state.fatigue + 0.6 + state.clutter_level * 0.002);
      if (state.fatigue > 70) state.sa_score = Math.max(0, state.sa_score - 0.6);
      if (state.fatigue > 80 && Math.random() < 0.3) triggerAlert();
      renderMeters();
    }

    function spawnTask() {
      if (!state.running) return;
      if (state.tasks.length > 3) return;
      const activeIds = activeInstrumentIds();
      const choice = activeIds[Math.floor(Math.random() * activeIds.length)];
      if (!choice) return;
      const inst = instruments.find((i) => i.id === choice);
      const type = Math.random() > 0.4 ? 'focus' : 'check';
      const task = {
        id: `${choice}-${Date.now()}`,
        instId: choice,
        type,
        expiresAt: Date.now() + (type === 'focus' ? 15000 : 12000),
        description: type === 'focus' ? `Group ${inst.kidName} inside the Focus Zone.` : `Tap ${inst.kidName} to confirm it's healthy.`,
      };
      addTask(task);
      renderTasks();
      checkTasks();
    }

    function startSimulation() {
      if (state.running) return;
      state.running = true;
      log('Simulation running ‚Äî respond to alerts and reorganize.');
      state.alertTimer = setInterval(triggerAlert, 3600);
      state.fatigueTimer = setInterval(tickFatigue, 1800);
      state.questionTimer = setInterval(askSAQuestion, 12000);
      state.taskTimer = setInterval(spawnTask, 5200);
      state.taskTickTimer = setInterval(tickTasks, 1000);
    }

    function stopSimulation() {
      state.running = false;
      clearInterval(state.alertTimer);
      clearInterval(state.fatigueTimer);
      clearInterval(state.questionTimer);
      clearInterval(state.taskTimer);
      clearInterval(state.taskTickTimer);
      state.alertTimer = state.fatigueTimer = state.questionTimer = state.taskTimer = state.taskTickTimer = null;
      log('Simulation paused.');
    }

    function updateSummary() {
      summaryList.innerHTML = '';
      const clutterLabel = state.clutter_level > 70 ? 'Super messy' : state.clutter_level > 45 ? 'A bit messy' : 'Very tidy';
      const awarenessLabel = state.sa_score > 70 ? 'Green' : state.sa_score > 40 ? 'Yellow' : 'Red';
      const feedbacks = [
        `Your cockpit is: ${clutterLabel}.`,
        `You caught ${state.hits} alerts and missed ${state.misses}.`,
        `Awareness bar stayed in the ${awarenessLabel} zone.`,
      ];
      if (state.clutter_level > 65) feedbacks.push('Try moving Speed, Height, and Direction closer together.');
      if (state.misses > 2) feedbacks.push('Watch for red flashes ‚Äî they matter most.');
      if (state.false_alarms > state.hits) feedbacks.push('Too many fake alerts! Read the message before tapping.');

      feedbacks.forEach((line) => {
        const li = document.createElement('li');
        li.textContent = line;
        summaryList.appendChild(li);
      });
    }

    function buildQuestionForType(type) {
      const activeIds = activeInstrumentIds();
      const pick = activeIds[Math.floor(Math.random() * activeIds.length)];
      const inst = instruments.find((i) => i.id === pick);
      if (!inst) return { prompt: 'What is your speed?', answer: '245' };

      if (type === 'perception') return { prompt: `What is your ${inst.kidName}?`, answer: inst.readout };
      if (type === 'comprehension') return { prompt: `Is ${inst.kidName} in the green?`, answer: 'yes' };
      return { prompt: `Where will ${inst.kidName} be in 10s?`, answer: 'stable' };
    }

    function askSAQuestion() {
      if (!state.running) return;
      quizOverlay.style.display = 'grid';
      const types = ['perception', 'comprehension', 'projection'];
      const type = types[Math.floor(Math.random() * types.length)];
      quizTitle.textContent = `Quick Check (${type})`;
      const q = buildQuestionForType(type);
      quizQuestion.textContent = q.prompt;
      quizOptions.innerHTML = '';

      // Always include the correct answer, then fill with simple distractors and shuffle.
      const pool = [q.answer, 'yes', 'no', 'stable'];
      const uniqueOptions = [...new Set(pool)];
      const options = uniqueOptions.slice(0, Math.max(3, Math.min(uniqueOptions.length, 4)));
      options.sort(() => Math.random() - 0.5);

      options.forEach((opt) => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.addEventListener('click', () => {
          const correct = opt === q.answer;
          const rt = 0; // simplified: not timing answers in this version
          updateSAScore(type, correct, rt);
          quizOverlay.style.display = 'none';
          log(correct ? 'Great situational awareness!' : 'SA check missed.');
          renderMeters();
        });
        quizOptions.appendChild(btn);
      });
    }

    function updateSAScore(type, correct, rt) {
      const speedBonus = rt < 2000 ? 1 : 0;
      const base = type === 'perception' ? 1 : type === 'comprehension' ? 2 : 3;
      if (correct) state.sa_score = Math.min(100, state.sa_score + base + speedBonus);
      else state.sa_score = Math.max(0, state.sa_score - base);
    }

    function activeInstrumentIds() {
      const level = LevelDesign[state.levelIndex] || LevelDesign[1];
      return level.ids;
    }

    function loadLevel(levelIndex) {
      state.levelIndex = levelIndex;
      instrumentArea.innerHTML = '';
      state.layout = {};
      state.elements = {};
      const level = LevelDesign[levelIndex];
      state.tasks = [];
      renderTasks();
      level.ids.forEach((id) => {
        const inst = instruments.find((i) => i.id === id);
        if (inst) createInstrument(inst);
      });
      updateClutterAndGrouping();
      renderDeckMap();
      log(`Loaded ${level.name}.`);
    }

    function startTutorial() {
      state.tutorialStep = TutorialStep.Intro;
      tutorialOverlay.style.display = 'flex';
      tutorialText.textContent = 'Welcome pilot! Let\'s make this cockpit kid-friendly.';
    }

    function nextTutorial() {
      state.tutorialStep += 1;
      if (state.tutorialStep === TutorialStep.ExplainSpeed) {
        tutorialText.textContent = 'This is your Speed gauge. Keep it in view.';
      } else if (state.tutorialStep === TutorialStep.ExplainHeight) {
        tutorialText.textContent = 'Height shows how high you fly. Place it near Speed.';
      } else if (state.tutorialStep === TutorialStep.ExplainFocus) {
        tutorialText.textContent = 'Drag Speed and Height into the glowing Focus Zone.';
      } else if (state.tutorialStep === TutorialStep.FirstAlert) {
        tutorialText.textContent = 'When something flashes red, tap it fast! Ready?';
      } else {
        tutorialOverlay.style.display = 'none';
        log('Tutorial complete.');
      }
    }

    function init() {
      loadLevel(1);
      updateClutterAndGrouping();
      instrumentArea.addEventListener('dragover', (e) => e.preventDefault());
      document.getElementById('start-btn').addEventListener('click', startSimulation);
      document.getElementById('stop-btn').addEventListener('click', stopSimulation);
      document.getElementById('shuffle-btn').addEventListener('click', shuffleClutter);
      document.getElementById('reset-btn').addEventListener('click', resetLayout);
      document.getElementById('tutorial-btn').addEventListener('click', startTutorial);
      document.getElementById('level-1').addEventListener('click', () => loadLevel(1));
      document.getElementById('level-2').addEventListener('click', () => loadLevel(2));
      document.getElementById('level-3').addEventListener('click', () => loadLevel(3));
      document.getElementById('level-4').addEventListener('click', () => loadLevel(4));
      document.getElementById('level-5').addEventListener('click', () => loadLevel(5));
      tutorialNext.addEventListener('click', nextTutorial);
      renderMeters();
      updateSummary();
      renderTasks();
    }

    init();
  </script>
</body>
</html>
